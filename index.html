<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=2.0, minimum-scale=0.5, user-scalable=yes">
    <title>Счетчик времени</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <link rel="icon" type="image/png" href="favicon.png">
    <link rel="apple-touch-icon" sizes="180x180" href="apple-touch-icon.png">
    <link rel="manifest" href="manifest.json">
    <meta name="theme-color" content="#4CAF50">
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 0;
            padding: 20px;
            background-color: var(--tg-theme-bg-color, #ffffff);
            color: var(--tg-theme-text-color, #000000);
            height: 100vh;
            overflow-x: hidden;
            overflow-y: auto;
        }
        .tracker {
            border: 1px solid var(--tg-theme-hint-color, #ccc);
            padding: 15px;
            margin-bottom: 15px;
            border-radius: 5px;
        }
        .container {
            text-align: center;
            max-width: 100%;
            width: 100%;
            box-sizing: border-box;
        }
        .input-group {
            margin: 10px 0;
        }
        .progress-bar {
            width: 100%;
            background-color: var(--tg-theme-secondary-bg-color, #f0f0f0);
            height: 20px;
            border-radius: 10px;
            margin-top: 10px;
            display: none;
        }
        .progress {
            width: 0%;
            height: 100%;
            background-color: var(--tg-theme-button-color, #4CAF50);
            border-radius: 10px;
            transition: width 0.3s;
        }
        button {
            padding: 5px 10px;
            margin: 5px;
            background-color: var(--tg-theme-button-color, #4CAF50);
            color: var(--tg-theme-button-text-color, #ffffff);
            border: none;
            border-radius: 5px;
            cursor: pointer;
        }
        .tracker-collapsed .details {
            display: none;
        }
        .tracker-collapsed .summary {
            margin: 0;
        }
        textarea {
            width: 100%;
            height: 80px;
            padding: 5px;
            box-sizing: border-box;
            resize: vertical;
        }
        .description-display, .text-display {
            white-space: pre-wrap;
            margin: 10px 0;
        }
        .file-list {
            margin-top: 10px;
        }
        .file-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin: 5px 0;
        }
        .file-item a {
            color: var(--tg-theme-link-color, #4CAF50);
            text-decoration: none;
        }
    </style>
</head>
<body>
    <div class="container">
        <h2>Счетчики времени</h2>
        <button onclick="toggleAllTrackers()">Свернуть все</button>
        <div id="trackers"></div>
        <button onclick="addTracker()">Добавить отслеживание</button>
    </div>

    <script>
        let trackerCount = 0;
        let allCollapsed = false;

        function addTracker(text = "Событие началось", startDate = "", endDate = "", description = "", files = []) {
            trackerCount++;
            const trackerDiv = document.createElement('div');
            trackerDiv.className = 'tracker';
            trackerDiv.id = `tracker-${trackerCount}`;
            
            trackerDiv.innerHTML = `
                <div class="summary">
                    <p id="time-${trackerCount}"></p>
                </div>
                <div class="details">
                    <div class="input-group">
                        <label>Название:</label>
                        <div id="text-display-${trackerCount}" class="text-display">${text}</div>
                        <input type="text" id="text-${trackerCount}" placeholder="Введите свой текст" value="${text}" style="display:none;">
                    </div>
                    <div class="input-group">
                        <label>Описание (опционально):</label>
                        <div id="description-display-${trackerCount}" class="description-display">${description}</div>
                        <textarea id="description-${trackerCount}" placeholder="Введите описание" style="display:none;">${description}</textarea>
                        <button onclick="editTracker(${trackerCount})">Редактировать</button>
                        <button onclick="saveTracker(${trackerCount})" style="display:none;">Сохранить</button>
                    </div>
                    <div class="input-group">
                        <label>Прикрепить файлы:</label>
                        <input type="file" id="file-input-${trackerCount}" multiple onchange="attachFiles(${trackerCount})">
                        <div id="file-list-${trackerCount}" class="file-list">${renderFiles(files, trackerCount)}</div>
                    </div>
                    <div class="input-group">
                        <label>Дата начала:</label>
                        <input type="date" id="start-${trackerCount}" value="${startDate}" onchange="updateTimer(${trackerCount}); saveTrackers()">
                    </div>
                    <div class="input-group">
                        <label>Дата окончания (опционально):</label>
                        <input type="date" id="end-${trackerCount}" value="${endDate}" onchange="updateTimer(${trackerCount}); saveTrackers()">
                    </div>
                    <div class="progress-bar" id="bar-${trackerCount}">
                        <div class="progress" id="progress-${trackerCount}"></div>
                    </div>
                    <p id="progress-text-${trackerCount}"></p>
                </div>
                <button onclick="toggleTracker(${trackerCount})">Свернуть</button>
                <button onclick="removeTracker(${trackerCount})">Удалить</button>
            `;
            
            document.getElementById('trackers').appendChild(trackerDiv);
            updateTimer(trackerCount);
            saveTrackers();
        }

        function removeTracker(id) {
            const tracker = document.getElementById(`tracker-${id}`);
            if (tracker) {
                localStorage.removeItem(`tracker-files-${id}`); // Удаляем файлы трекера
                tracker.remove();
                saveTrackers();
            }
        }

        function toggleTracker(id) {
            const tracker = document.getElementById(`tracker-${id}`);
            const toggleButton = tracker.querySelector('button[onclick^="toggleTracker"]');
            if (tracker.classList.contains('tracker-collapsed')) {
                tracker.classList.remove('tracker-collapsed');
                toggleButton.textContent = 'Свернуть';
            } else {
                tracker.classList.add('tracker-collapsed');
                toggleButton.textContent = 'Развернуть';
            }
        }

        function toggleAllTrackers() {
            allCollapsed = !allCollapsed;
            const trackers = document.querySelectorAll('.tracker');
            const toggleAllButton = document.querySelector('button[onclick="toggleAllTrackers()"]');
            trackers.forEach(tracker => {
                const id = tracker.id.split('-')[1];
                const toggleButton = tracker.querySelector('button[onclick^="toggleTracker"]');
                if (allCollapsed) {
                    tracker.classList.add('tracker-collapsed');
                    toggleButton.textContent = 'Развернуть';
                } else {
                    tracker.classList.remove('tracker-collapsed');
                    toggleButton.textContent = 'Свернуть';
                }
            });
            toggleAllButton.textContent = allCollapsed ? 'Развернуть все' : 'Свернуть все';
        }

        function editTracker(id) {
            const textDisplay = document.getElementById(`text-display-${id}`);
            const textInput = document.getElementById(`text-${id}`);
            const descDisplay = document.getElementById(`description-display-${id}`);
            const descTextarea = document.getElementById(`description-${id}`);
            const editButton = document.querySelector(`button[onclick="editTracker(${id})"]`);
            const saveButton = document.querySelector(`button[onclick="saveTracker(${id})"]`);
            
            textDisplay.style.display = 'none';
            textInput.style.display = 'block';
            descDisplay.style.display = 'none';
            descTextarea.style.display = 'block';
            editButton.style.display = 'none';
            saveButton.style.display = 'inline';
        }

        function saveTracker(id) {
            const textDisplay = document.getElementById(`text-display-${id}`);
            const textInput = document.getElementById(`text-${id}`);
            const descDisplay = document.getElementById(`description-display-${id}`);
            const descTextarea = document.getElementById(`description-${id}`);
            const editButton = document.querySelector(`button[onclick="editTracker(${id})"]`);
            const saveButton = document.querySelector(`button[onclick="saveTracker(${id})"]`);
            
            textDisplay.textContent = textInput.value;
            textDisplay.style.display = 'block';
            textInput.style.display = 'none';
            descDisplay.textContent = descTextarea.value;
            descDisplay.style.display = 'block';
            descTextarea.style.display = 'none';
            editButton.style.display = 'inline';
            saveButton.style.display = 'none';
            updateTimer(id); // Обновляем время с новым названием
            saveTrackers();
        }

        function attachFiles(id) {
            const fileInput = document.getElementById(`file-input-${id}`);
            const fileList = document.getElementById(`file-list-${id}`);
            const files = Array.from(fileInput.files);

            files.forEach(file => {
                const reader = new FileReader();
                reader.onload = function(e) {
                    const fileData = {
                        name: file.name,
                        data: e.target.result,
                        type: file.type
                    };
                    const existingFiles = JSON.parse(localStorage.getItem(`tracker-files-${id}`) || '[]');
                    existingFiles.push(fileData);
                    localStorage.setItem(`tracker-files-${id}`, JSON.stringify(existingFiles));
                    fileList.innerHTML = renderFiles(existingFiles, id);
                    saveTrackers();
                };
                reader.readAsDataURL(file);
            });
            fileInput.value = '';
        }

        function renderFiles(files, id) {
            return files.map((file, index) => `
                <div class="file-item">
                    <a href="${file.data}" download="${file.name}">${file.name}</a>
                    <button onclick="removeFile(${id}, ${index})">Удалить</button>
                </div>
            `).join('');
        }

        function removeFile(id, index) {
            const files = JSON.parse(localStorage.getItem(`tracker-files-${id}`) || '[]');
            files.splice(index, 1);
            localStorage.setItem(`tracker-files-${id}`, JSON.stringify(files));
            document.getElementById(`file-list-${id}`).innerHTML = renderFiles(files, id);
            saveTrackers();
        }

        function calculateRemainingTime(remainingTime) {
            const remainingDays = Math.ceil(remainingTime / (1000 * 60 * 60 * 24));
            const years = Math.floor(remainingDays / 365);
            const months = Math.floor((remainingDays % 365) / 30);
            const weeks = Math.floor((remainingDays % 30) / 7);
            const days = remainingDays % 7;

            let result = 'Осталось: ';
            if (years > 0) result += `${years} лет `;
            if (months > 0) result += `${months} месяцев `;
            if (weeks > 0) result += `${weeks} недель `;
            if (days > 0) result += `${days} дней`;
            return result.trim();
        }

        function updateTimer(id) {
            const startDate = new Date(document.getElementById(`start-${id}`).value);
            const endDate = document.getElementById(`end-${id}`).value ? 
                new Date(document.getElementById(`end-${id}`).value) : null;
            const customText = document.getElementById(`text-${id}`).value || 'Событие началось';
            const now = new Date();

            if (!startDate || isNaN(startDate)) {
                document.getElementById(`time-${id}`).textContent = 'Выберите дату начала';
                return;
            }

            const diffTime = Math.abs(now - startDate);
            const diffDays = Math.floor(diffTime / (1000 * 60 * 60 * 24));
            const years = Math.floor(diffDays / 365);
            const months = Math.floor((diffDays % 365) / 30);
            const days = diffDays % 30;

            let timeString = `${customText} `;
            if (years > 0) timeString += `${years} лет `;
            if (months > 0) timeString += `${months} месяцев `;
            if (days > 0) timeString += `${days} дней назад`;

            document.getElementById(`time-${id}`).textContent = timeString;

            const progressBar = document.getElementById(`bar-${id}`);
            const progressText = document.getElementById(`progress-text-${id}`);
            
            if (endDate && !isNaN(endDate) && endDate > startDate) {
                const totalTime = endDate - startDate;
                const passedTime = now - startDate;
                const progress = Math.min((passedTime / totalTime) * 100, 100);
                
                progressBar.style.display = 'block';
                document.getElementById(`progress-${id}`).style.width = `${progress}%`;
                
                const remainingTime = endDate - now;
                if (remainingTime > 0) {
                    progressText.textContent = `${calculateRemainingTime(remainingTime)} (${progress.toFixed(1)}%)`;
                } else {
                    progressText.textContent = 'Срок истек';
                }
            } else {
                progressBar.style.display = 'none';
                progressText.textContent = '';
            }
        }

        function saveTrackers() {
            const trackers = [];
            for (let i = 1; i <= trackerCount; i++) {
                if (document.getElementById(`tracker-${i}`)) {
                    const text = document.getElementById(`text-${i}`).value;
                    const description = document.getElementById(`description-${i}`).value;
                    const start = document.getElementById(`start-${i}`).value;
                    const end = document.getElementById(`end-${i}`).value;
                    const files = JSON.parse(localStorage.getItem(`tracker-files-${i}`) || '[]');
                    trackers.push({ id: i, text, description, start, end, files });
                }
            }
            localStorage.setItem('timeTrackers', JSON.stringify(trackers));
        }

        function loadTrackers() {
            const savedTrackers = localStorage.getItem('timeTrackers');
            if (savedTrackers) {
                const trackers = JSON.parse(savedTrackers);
                trackers.forEach(tracker => {
                    localStorage.setItem(`tracker-files-${tracker.id}`, JSON.stringify(tracker.files || []));
                    addTracker(tracker.text, tracker.start, tracker.end, tracker.description, tracker.files || []);
                    if (tracker.id > trackerCount) trackerCount = tracker.id;
                });
            } else {
                addTracker();
            }
        }

        window.Telegram.WebApp.ready();
        window.Telegram.WebApp.expand();

        setInterval(() => {
            for (let i = 1; i <= trackerCount; i++) {
                if (document.getElementById(`tracker-${i}`)) {
                    updateTimer(i);
                }
            }
        }, 1000);

        loadTrackers();
    </script>
</body>
</html>
